import React, { useState, useEffect } from 'react';

const TodaysManna = () => {
  // 상태 관리
  const [status, setStatus] = useState({ type: 'loading', message: '성경 데이터를 불러오는 중...' });
  const [bibleData, setBibleData] = useState(null);
  const [selectedDate, setSelectedDate] = useState(getTodayString());
  const [selectedBook, setSelectedBook] = useState('');
  const [selectedChapter, setSelectedChapter] = useState('');
  const [chapters, setChapters] = useState([]);
  const [devotionalText, setDevotionalText] = useState('성경책과 장을 선택한 후 "묵상 생성하기" 버튼을 클릭하세요.');
  const [rawDevotionalText, setRawDevotionalText] = useState('');
  const [copySuccess, setCopySuccess] = useState(false);
  const [showCopyMessage, setShowCopyMessage] = useState(false);

  // 오늘 날짜를 YYYY-MM-DD 형식으로 가져오는 함수
  function getTodayString() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // 날짜 문자열 포맷 변환 (YYYY-MM-DD -> M/D(요일))
  function formatDateString(dateStr) {
    if (!dateStr) return '';
    
    const date = new Date(dateStr);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
    const weekday = weekdays[date.getDay()];
    
    return `${month}/${day}(${weekday})`;
  }

  // 성경 데이터 로드
  useEffect(() => {
    async function loadBibleData() {
      try {
        setStatus({ type: 'loading', message: '성경 데이터를 불러오는 중...' });
        
        // GitHub에서 데이터 요청 (실제 API 요청은 주석 처리하고 샘플 데이터 사용)
        // const response = await fetch('https://raw.githubusercontent.com/jeriong/bible-data/refs/heads/main/%EC%84%B1%EA%B2%BD.json');
        // if (!response.ok) {
        //   throw new Error(`HTTP 오류: ${response.status}`);
        // }
        // const data = await response.json();
        
        // 샘플 데이터 사용 (실제로는 위의 API 요청으로 대체)
        const data = {
          "창세기": {
            "1": {
              "1": "태초에 하나님이 천지를 창조하시니라",
              "2": "땅이 혼돈하고 공허하며 흑암이 깊음 위에 있고 하나님의 영은 수면 위에 운행하시니라",
              "3": "하나님이 가라사대 빛이 있으라 하시매 빛이 있었고",
              "4": "빛이 하나님이 보시기에 좋았더라 하나님이 빛과 어둠을 나누사"
            },
            "2": {
              "1": "천지와 만물이 다 이루니라",
              "2": "하나님이 그가 하시던 일을 일곱째 날에 마치시니 그가 하시던 모든 일을 그치고 일곱째 날에 안식하시니라"
            }
          },
          "요한복음": {
            "3": {
              "16": "하나님이 세상을 이처럼 사랑하사 독생자를 주셨으니 이는 저를 믿는 자마다 멸망치 않고 영생을 얻게 하려 하심이니라",
              "17": "하나님이 그 아들을 세상에 보내신 것은 세상을 심판하려 하심이 아니요 저로 말미암아 세상이 구원을 받게 하려 하심이라"
            }
          },
          "시편": {
            "23": {
              "1": "여호와는 나의 목자시니 내게 부족함이 없으리로다",
              "2": "그가 나를 푸른 초장에 누이시며 쉴 만한 물가로 인도하시는도다",
              "3": "내 영혼을 소생시키시고 자기 이름을 위하여 의의 길로 인도하시는도다"
            }
          }
        };
        
        setBibleData(data);
        setStatus({ type: 'success', message: '성경 데이터를 성공적으로 불러왔습니다!' });
      } catch (error) {
        console.error('데이터 로드 중 오류 발생:', error);
        setStatus({ type: 'error', message: `성경 데이터를 불러올 수 없습니다: ${error.message}` });
        
        // 오류 발생 시 백업 데이터 사용
        const backupData = {
          "창세기": {
            "1": {
              "1": "태초에 하나님이 천지를 창조하시니라",
              "2": "땅이 혼돈하고 공허하며 흑암이 깊음 위에 있고 하나님의 영은 수면 위에 운행하시니라"
            }
          },
          "요한복음": {
            "3": {
              "16": "하나님이 세상을 이처럼 사랑하사 독생자를 주셨으니 이는 저를 믿는 자마다 멸망치 않고 영생을 얻게 하려 하심이니라"
            }
          }
        };
        
        setBibleData(backupData);
      }
    }
    
    loadBibleData();
  }, []);

  // 성경책 변경 시 장 업데이트
  useEffect(() => {
    if (selectedBook && bibleData && bibleData[selectedBook]) {
      const chapterNumbers = Object.keys(bibleData[selectedBook])
        .map(chapter => parseInt(chapter))
        .sort((a, b) => a - b);
      setChapters(chapterNumbers);
      setSelectedChapter('');
    } else {
      setChapters([]);
      setSelectedChapter('');
    }
  }, [selectedBook, bibleData]);

  // 폼 유효성 검사 - 날짜 없이도 생성 가능하도록 수정
  const isFormValid = selectedBook && selectedChapter;

  // 복사 기능
  const copyToClipboard = () => {
    navigator.clipboard.writeText(rawDevotionalText)
      .then(() => {
        setCopySuccess(true);
        setShowCopyMessage(true);
        
        setTimeout(() => {
          setShowCopyMessage(false);
        }, 2000);
        
        setTimeout(() => {
          setCopySuccess(false);
        }, 3000);
      })
      .catch(err => {
        console.error('클립보드 복사 실패:', err);
        setCopySuccess(false);
      });
  };

  // 묵상 생성
  const generateDevotional = () => {
    try {
      // 날짜 정보 (선택적)
      let dateStr = '';
      let weekdayIndex = -1;
      
      if (selectedDate) {
        const date = new Date(selectedDate);
        dateStr = formatDateString(selectedDate);
        weekdayIndex = date.getDay();
      }
      
      // 일요일이고 날짜가 선택된 경우
      if (weekdayIndex === 0 && selectedDate) {
        const formattedText = `🍚오늘의 만나🍚 - ${dateStr}\n\n오늘은 일요일입니다.\n교회에서 예배드리고 말씀을 듣는 복된 날이 되시기 바랍니다.`;
        setRawDevotionalText(formattedText);
        setDevotionalText(formattedText.replace(/\n/g, '<br>'));
        return;
      }
      
      // 성경 구절 가져오기
      const chapterData = bibleData[selectedBook][selectedChapter];
      
      if (!chapterData) {
        const errorText = `${selectedBook} ${selectedChapter}장의 데이터를 찾을 수 없습니다.`;
        setRawDevotionalText(errorText);
        setDevotionalText(errorText);
        return;
      }
      
      // 절 번호를 정수로 변환하여 정렬
      const verses = [];
      const sortedVerseNumbers = Object.keys(chapterData)
        .map(verse => parseInt(verse))
        .sort((a, b) => a - b);
      
      for (const verseNum of sortedVerseNumbers) {
        verses.push(`${verseNum}. ${chapterData[verseNum.toString()]}`);
      }
      
      // 묵상 내용 생성
      let result = '';
      
      // 날짜가 선택된 경우에만 날짜 포함
      if (selectedDate) {
        result += `🍚오늘의 만나🍚 - ${dateStr}\n\n`;
      } else {
        result += `🍚오늘의 만나🍚\n\n`;
      }
      
      result += `${selectedBook} ${selectedChapter}장 입니다\n`;
      result += "------------------------------------------------\n\n";
      
      result += `**${selectedBook} ${selectedChapter}장**\n\n`;
      result += verses.join('\n\n') + '\n\n';
      
      result += "------------------------------------------------\n\n";
      result += "💌묵상방법(참고)💌\n";
      result += "1. 시작기도🙏 후 말씀 읽기(천천히 깊게)\n\n\n";
      result += "2. 묵상하기\n";
      result += "👉나에게 묵상되는 말씀범위(구절)의 \"핵심제목<Keyword >\" 적어보기\n";
      result += "👉\"핵심제목<Keyword >\" 에 맞는 묵상, 주님과의 약속/구체적 실천계획 세워보기\n\n\n";
      result += "3. 마무리기도🙏 후 댓글로 묵상 나누기 (말씀구절/묵상/실천 등을 댓글로 달아 공유해주시면 좋습니다!)\n";
      result += "------------------------------------------------";
      
      setRawDevotionalText(result);
      
      // 텍스트에서 **로 감싸진 부분을 <strong> 태그로 변환
      const formattedText = result
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      
      setDevotionalText(formattedText);
      
    } catch (error) {
      console.error('묵상 생성 중 오류 발생:', error);
      setDevotionalText(`오류 발생: ${error.message}`);
      setRawDevotionalText('');
    }
  };

  return (
    <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
      <h1 className="text-center text-2xl font-bold text-blue-700 mb-6">🍚 오늘의 만나 - 성경 묵상 앱</h1>
      
      {/* 상태 표시 */}
      <div className={`text-center p-3 mb-6 rounded-md ${
        status.type === 'loading' ? 'bg-blue-100 text-blue-800' :
        status.type === 'success' ? 'bg-green-100 text-green-800' :
        'bg-red-100 text-red-800'
      }`}>
        {status.message}
        {status.type === 'loading' && (
          <div className="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mt-2"></div>
        )}
      </div>
      
      <div className="flex flex-col md:flex-row gap-6">
        {/* 설정 영역 */}
        <div className="w-full md:w-1/2">
          <h2 className="text-xl font-medium text-blue-700 pb-2 border-b border-gray-200 mb-4">설정</h2>
          
          <div className="mb-4">
            <label htmlFor="date" className="block font-medium mb-1">1. 날짜 선택 (선택사항):</label>
            <input
              type="date"
              id="date"
              className="w-full p-2 border border-gray-300 rounded-md"
              value={selectedDate}
              onChange={(e) => setSelectedDate(e.target.value)}
            />
          </div>
          
          <div className="mb-4">
            <label htmlFor="book" className="block font-medium mb-1">2. 성경책 선택:</label>
            <select
              id="book"
              className="w-full p-2 border border-gray-300 rounded-md bg-white"
              value={selectedBook}
              onChange={(e) => setSelectedBook(e.target.value)}
            >
              <option value="" disabled>성경책을 선택하세요</option>
              {bibleData && Object.keys(bibleData).map((book) => (
                <option key={book} value={book}>{book}</option>
              ))}
            </select>
          </div>
          
          <div className="mb-4">
            <label htmlFor="chapter" className="block font-medium mb-1">3. 장 선택:</label>
            <select
              id="chapter"
              className="w-full p-2 border border-gray-300 rounded-md bg-white"
              value={selectedChapter}
              onChange={(e) => setSelectedChapter(e.target.value)}
              disabled={!selectedBook}
            >
              <option value="" disabled>장을 선택하세요</option>
              {chapters.map((chapter) => (
                <option key={chapter} value={chapter}>{chapter}장</option>
              ))}
            </select>
          </div>
          
          <button
            className={`w-full p-3 rounded-md font-medium transition-colors ${
              isFormValid 
                ? 'bg-blue-600 text-white hover:bg-blue-700' 
                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
            }`}
            onClick={generateDevotional}
            disabled={!isFormValid}
          >
            묵상 생성하기
          </button>
        </div>
        
        {/* 묵상 영역 */}
        <div className="w-full md:w-1/2">
          <h2 className="text-xl font-medium text-blue-700 pb-2 border-b border-gray-200 mb-4">오늘의 만나</h2>
          
          <div className="relative">
            <div
              className="whitespace-pre-wrap p-4 bg-gray-50 rounded-md border-l-4 border-blue-600"
              dangerouslySetInnerHTML={{ __html: devotionalText }}
            />
            
            {rawDevotionalText && (
              <button
                className={`w-full mt-3 p-2 rounded-md font-medium transition-colors ${
                  copySuccess 
                    ? 'bg-gray-500 text-white' 
                    : 'bg-green-600 text-white hover:bg-green-700'
                }`}
                onClick={copyToClipboard}
              >
                {copySuccess ? '✓ 복사됨' : '📋 복사하기'}
              </button>
            )}
          </div>
        </div>
      </div>
      
      <footer className="text-center mt-8 text-gray-500 text-sm">
        <p>이 앱은 GitHub에서 호스팅되는 성경 데이터를 사용합니다.</p>
      </footer>
      
      {/* 복사 성공 메시지 */}
      <div className={`fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-md shadow-md transition-opacity duration-300 ${
        showCopyMessage ? 'opacity-100' : 'opacity-0'
      }`}>
        클립보드에 복사되었습니다!
      </div>
    </div>
  );
};

export default TodaysManna;
