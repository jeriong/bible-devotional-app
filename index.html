import React, { useState, useEffect } from 'react';

const TodaysManna = () => {
  // ìƒíƒœ ê´€ë¦¬
  const [status, setStatus] = useState({ type: 'loading', message: 'ì„±ê²½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...' });
  const [bibleData, setBibleData] = useState(null);
  const [selectedDate, setSelectedDate] = useState(getTodayString());
  const [selectedBook, setSelectedBook] = useState('');
  const [selectedChapter, setSelectedChapter] = useState('');
  const [chapters, setChapters] = useState([]);
  const [devotionalText, setDevotionalText] = useState('ì„±ê²½ì±…ê³¼ ì¥ì„ ì„ íƒí•œ í›„ "ë¬µìƒ ìƒì„±í•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
  const [rawDevotionalText, setRawDevotionalText] = useState('');
  const [copySuccess, setCopySuccess] = useState(false);
  const [showCopyMessage, setShowCopyMessage] = useState(false);

  // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
  function getTodayString() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // ë‚ ì§œ ë¬¸ìì—´ í¬ë§· ë³€í™˜ (YYYY-MM-DD -> M/D(ìš”ì¼))
  function formatDateString(dateStr) {
    if (!dateStr) return '';
    
    const date = new Date(dateStr);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const weekday = weekdays[date.getDay()];
    
    return `${month}/${day}(${weekday})`;
  }

  // ì„±ê²½ ë°ì´í„° ë¡œë“œ
  useEffect(() => {
    async function loadBibleData() {
      try {
        setStatus({ type: 'loading', message: 'ì„±ê²½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...' });
        
        // GitHubì—ì„œ ë°ì´í„° ìš”ì²­ (ì‹¤ì œ API ìš”ì²­ì€ ì£¼ì„ ì²˜ë¦¬í•˜ê³  ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©)
        // const response = await fetch('https://raw.githubusercontent.com/jeriong/bible-data/refs/heads/main/%EC%84%B1%EA%B2%BD.json');
        // if (!response.ok) {
        //   throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
        // }
        // const data = await response.json();
        
        // ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš© (ì‹¤ì œë¡œëŠ” ìœ„ì˜ API ìš”ì²­ìœ¼ë¡œ ëŒ€ì²´)
        const data = {
          "ì°½ì„¸ê¸°": {
            "1": {
              "1": "íƒœì´ˆì— í•˜ë‚˜ë‹˜ì´ ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹œë‹ˆë¼",
              "2": "ë•…ì´ í˜¼ëˆí•˜ê³  ê³µí—ˆí•˜ë©° í‘ì•”ì´ ê¹ŠìŒ ìœ„ì— ìˆê³  í•˜ë‚˜ë‹˜ì˜ ì˜ì€ ìˆ˜ë©´ ìœ„ì— ìš´í–‰í•˜ì‹œë‹ˆë¼",
              "3": "í•˜ë‚˜ë‹˜ì´ ê°€ë¼ì‚¬ëŒ€ ë¹›ì´ ìˆìœ¼ë¼ í•˜ì‹œë§¤ ë¹›ì´ ìˆì—ˆê³ ",
              "4": "ë¹›ì´ í•˜ë‚˜ë‹˜ì´ ë³´ì‹œê¸°ì— ì¢‹ì•˜ë”ë¼ í•˜ë‚˜ë‹˜ì´ ë¹›ê³¼ ì–´ë‘ ì„ ë‚˜ëˆ„ì‚¬"
            },
            "2": {
              "1": "ì²œì§€ì™€ ë§Œë¬¼ì´ ë‹¤ ì´ë£¨ë‹ˆë¼",
              "2": "í•˜ë‚˜ë‹˜ì´ ê·¸ê°€ í•˜ì‹œë˜ ì¼ì„ ì¼ê³±ì§¸ ë‚ ì— ë§ˆì¹˜ì‹œë‹ˆ ê·¸ê°€ í•˜ì‹œë˜ ëª¨ë“  ì¼ì„ ê·¸ì¹˜ê³  ì¼ê³±ì§¸ ë‚ ì— ì•ˆì‹í•˜ì‹œë‹ˆë¼"
            }
          },
          "ìš”í•œë³µìŒ": {
            "3": {
              "16": "í•˜ë‚˜ë‹˜ì´ ì„¸ìƒì„ ì´ì²˜ëŸ¼ ì‚¬ë‘í•˜ì‚¬ ë…ìƒìë¥¼ ì£¼ì…¨ìœ¼ë‹ˆ ì´ëŠ” ì €ë¥¼ ë¯¿ëŠ” ìë§ˆë‹¤ ë©¸ë§ì¹˜ ì•Šê³  ì˜ìƒì„ ì–»ê²Œ í•˜ë ¤ í•˜ì‹¬ì´ë‹ˆë¼",
              "17": "í•˜ë‚˜ë‹˜ì´ ê·¸ ì•„ë“¤ì„ ì„¸ìƒì— ë³´ë‚´ì‹  ê²ƒì€ ì„¸ìƒì„ ì‹¬íŒí•˜ë ¤ í•˜ì‹¬ì´ ì•„ë‹ˆìš” ì €ë¡œ ë§ë¯¸ì•”ì•„ ì„¸ìƒì´ êµ¬ì›ì„ ë°›ê²Œ í•˜ë ¤ í•˜ì‹¬ì´ë¼"
            }
          },
          "ì‹œí¸": {
            "23": {
              "1": "ì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ëª©ìì‹œë‹ˆ ë‚´ê²Œ ë¶€ì¡±í•¨ì´ ì—†ìœ¼ë¦¬ë¡œë‹¤",
              "2": "ê·¸ê°€ ë‚˜ë¥¼ í‘¸ë¥¸ ì´ˆì¥ì— ëˆ„ì´ì‹œë©° ì‰´ ë§Œí•œ ë¬¼ê°€ë¡œ ì¸ë„í•˜ì‹œëŠ”ë„ë‹¤",
              "3": "ë‚´ ì˜í˜¼ì„ ì†Œìƒì‹œí‚¤ì‹œê³  ìê¸° ì´ë¦„ì„ ìœ„í•˜ì—¬ ì˜ì˜ ê¸¸ë¡œ ì¸ë„í•˜ì‹œëŠ”ë„ë‹¤"
            }
          }
        };
        
        setBibleData(data);
        setStatus({ type: 'success', message: 'ì„±ê²½ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!' });
      } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        setStatus({ type: 'error', message: `ì„±ê²½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}` });
        
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë°±ì—… ë°ì´í„° ì‚¬ìš©
        const backupData = {
          "ì°½ì„¸ê¸°": {
            "1": {
              "1": "íƒœì´ˆì— í•˜ë‚˜ë‹˜ì´ ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹œë‹ˆë¼",
              "2": "ë•…ì´ í˜¼ëˆí•˜ê³  ê³µí—ˆí•˜ë©° í‘ì•”ì´ ê¹ŠìŒ ìœ„ì— ìˆê³  í•˜ë‚˜ë‹˜ì˜ ì˜ì€ ìˆ˜ë©´ ìœ„ì— ìš´í–‰í•˜ì‹œë‹ˆë¼"
            }
          },
          "ìš”í•œë³µìŒ": {
            "3": {
              "16": "í•˜ë‚˜ë‹˜ì´ ì„¸ìƒì„ ì´ì²˜ëŸ¼ ì‚¬ë‘í•˜ì‚¬ ë…ìƒìë¥¼ ì£¼ì…¨ìœ¼ë‹ˆ ì´ëŠ” ì €ë¥¼ ë¯¿ëŠ” ìë§ˆë‹¤ ë©¸ë§ì¹˜ ì•Šê³  ì˜ìƒì„ ì–»ê²Œ í•˜ë ¤ í•˜ì‹¬ì´ë‹ˆë¼"
            }
          }
        };
        
        setBibleData(backupData);
      }
    }
    
    loadBibleData();
  }, []);

  // ì„±ê²½ì±… ë³€ê²½ ì‹œ ì¥ ì—…ë°ì´íŠ¸
  useEffect(() => {
    if (selectedBook && bibleData && bibleData[selectedBook]) {
      const chapterNumbers = Object.keys(bibleData[selectedBook])
        .map(chapter => parseInt(chapter))
        .sort((a, b) => a - b);
      setChapters(chapterNumbers);
      setSelectedChapter('');
    } else {
      setChapters([]);
      setSelectedChapter('');
    }
  }, [selectedBook, bibleData]);

  // í¼ ìœ íš¨ì„± ê²€ì‚¬ - ë‚ ì§œ ì—†ì´ë„ ìƒì„± ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì •
  const isFormValid = selectedBook && selectedChapter;

  // ë³µì‚¬ ê¸°ëŠ¥
  const copyToClipboard = () => {
    navigator.clipboard.writeText(rawDevotionalText)
      .then(() => {
        setCopySuccess(true);
        setShowCopyMessage(true);
        
        setTimeout(() => {
          setShowCopyMessage(false);
        }, 2000);
        
        setTimeout(() => {
          setCopySuccess(false);
        }, 3000);
      })
      .catch(err => {
        console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
        setCopySuccess(false);
      });
  };

  // ë¬µìƒ ìƒì„±
  const generateDevotional = () => {
    try {
      // ë‚ ì§œ ì •ë³´ (ì„ íƒì )
      let dateStr = '';
      let weekdayIndex = -1;
      
      if (selectedDate) {
        const date = new Date(selectedDate);
        dateStr = formatDateString(selectedDate);
        weekdayIndex = date.getDay();
      }
      
      // ì¼ìš”ì¼ì´ê³  ë‚ ì§œê°€ ì„ íƒëœ ê²½ìš°
      if (weekdayIndex === 0 && selectedDate) {
        const formattedText = `ğŸšì˜¤ëŠ˜ì˜ ë§Œë‚˜ğŸš - ${dateStr}\n\nì˜¤ëŠ˜ì€ ì¼ìš”ì¼ì…ë‹ˆë‹¤.\nêµíšŒì—ì„œ ì˜ˆë°°ë“œë¦¬ê³  ë§ì”€ì„ ë“£ëŠ” ë³µëœ ë‚ ì´ ë˜ì‹œê¸° ë°”ëë‹ˆë‹¤.`;
        setRawDevotionalText(formattedText);
        setDevotionalText(formattedText.replace(/\n/g, '<br>'));
        return;
      }
      
      // ì„±ê²½ êµ¬ì ˆ ê°€ì ¸ì˜¤ê¸°
      const chapterData = bibleData[selectedBook][selectedChapter];
      
      if (!chapterData) {
        const errorText = `${selectedBook} ${selectedChapter}ì¥ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
        setRawDevotionalText(errorText);
        setDevotionalText(errorText);
        return;
      }
      
      // ì ˆ ë²ˆí˜¸ë¥¼ ì •ìˆ˜ë¡œ ë³€í™˜í•˜ì—¬ ì •ë ¬
      const verses = [];
      const sortedVerseNumbers = Object.keys(chapterData)
        .map(verse => parseInt(verse))
        .sort((a, b) => a - b);
      
      for (const verseNum of sortedVerseNumbers) {
        verses.push(`${verseNum}. ${chapterData[verseNum.toString()]}`);
      }
      
      // ë¬µìƒ ë‚´ìš© ìƒì„±
      let result = '';
      
      // ë‚ ì§œê°€ ì„ íƒëœ ê²½ìš°ì—ë§Œ ë‚ ì§œ í¬í•¨
      if (selectedDate) {
        result += `ğŸšì˜¤ëŠ˜ì˜ ë§Œë‚˜ğŸš - ${dateStr}\n\n`;
      } else {
        result += `ğŸšì˜¤ëŠ˜ì˜ ë§Œë‚˜ğŸš\n\n`;
      }
      
      result += `${selectedBook} ${selectedChapter}ì¥ ì…ë‹ˆë‹¤\n`;
      result += "------------------------------------------------\n\n";
      
      result += `**${selectedBook} ${selectedChapter}ì¥**\n\n`;
      result += verses.join('\n\n') + '\n\n';
      
      result += "------------------------------------------------\n\n";
      result += "ğŸ’Œë¬µìƒë°©ë²•(ì°¸ê³ )ğŸ’Œ\n";
      result += "1. ì‹œì‘ê¸°ë„ğŸ™ í›„ ë§ì”€ ì½ê¸°(ì²œì²œíˆ ê¹Šê²Œ)\n\n\n";
      result += "2. ë¬µìƒí•˜ê¸°\n";
      result += "ğŸ‘‰ë‚˜ì—ê²Œ ë¬µìƒë˜ëŠ” ë§ì”€ë²”ìœ„(êµ¬ì ˆ)ì˜ \"í•µì‹¬ì œëª©<Keyword >\" ì ì–´ë³´ê¸°\n";
      result += "ğŸ‘‰\"í•µì‹¬ì œëª©<Keyword >\" ì— ë§ëŠ” ë¬µìƒ, ì£¼ë‹˜ê³¼ì˜ ì•½ì†/êµ¬ì²´ì  ì‹¤ì²œê³„íš ì„¸ì›Œë³´ê¸°\n\n\n";
      result += "3. ë§ˆë¬´ë¦¬ê¸°ë„ğŸ™ í›„ ëŒ“ê¸€ë¡œ ë¬µìƒ ë‚˜ëˆ„ê¸° (ë§ì”€êµ¬ì ˆ/ë¬µìƒ/ì‹¤ì²œ ë“±ì„ ëŒ“ê¸€ë¡œ ë‹¬ì•„ ê³µìœ í•´ì£¼ì‹œë©´ ì¢‹ìŠµë‹ˆë‹¤!)\n";
      result += "------------------------------------------------";
      
      setRawDevotionalText(result);
      
      // í…ìŠ¤íŠ¸ì—ì„œ **ë¡œ ê°ì‹¸ì§„ ë¶€ë¶„ì„ <strong> íƒœê·¸ë¡œ ë³€í™˜
      const formattedText = result
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      
      setDevotionalText(formattedText);
      
    } catch (error) {
      console.error('ë¬µìƒ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
      setDevotionalText(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
      setRawDevotionalText('');
    }
  };

  return (
    <div className="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
      <h1 className="text-center text-2xl font-bold text-blue-700 mb-6">ğŸš ì˜¤ëŠ˜ì˜ ë§Œë‚˜ - ì„±ê²½ ë¬µìƒ ì•±</h1>
      
      {/* ìƒíƒœ í‘œì‹œ */}
      <div className={`text-center p-3 mb-6 rounded-md ${
        status.type === 'loading' ? 'bg-blue-100 text-blue-800' :
        status.type === 'success' ? 'bg-green-100 text-green-800' :
        'bg-red-100 text-red-800'
      }`}>
        {status.message}
        {status.type === 'loading' && (
          <div className="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mt-2"></div>
        )}
      </div>
      
      <div className="flex flex-col md:flex-row gap-6">
        {/* ì„¤ì • ì˜ì—­ */}
        <div className="w-full md:w-1/2">
          <h2 className="text-xl font-medium text-blue-700 pb-2 border-b border-gray-200 mb-4">ì„¤ì •</h2>
          
          <div className="mb-4">
            <label htmlFor="date" className="block font-medium mb-1">1. ë‚ ì§œ ì„ íƒ (ì„ íƒì‚¬í•­):</label>
            <input
              type="date"
              id="date"
              className="w-full p-2 border border-gray-300 rounded-md"
              value={selectedDate}
              onChange={(e) => setSelectedDate(e.target.value)}
            />
          </div>
          
          <div className="mb-4">
            <label htmlFor="book" className="block font-medium mb-1">2. ì„±ê²½ì±… ì„ íƒ:</label>
            <select
              id="book"
              className="w-full p-2 border border-gray-300 rounded-md bg-white"
              value={selectedBook}
              onChange={(e) => setSelectedBook(e.target.value)}
            >
              <option value="" disabled>ì„±ê²½ì±…ì„ ì„ íƒí•˜ì„¸ìš”</option>
              {bibleData && Object.keys(bibleData).map((book) => (
                <option key={book} value={book}>{book}</option>
              ))}
            </select>
          </div>
          
          <div className="mb-4">
            <label htmlFor="chapter" className="block font-medium mb-1">3. ì¥ ì„ íƒ:</label>
            <select
              id="chapter"
              className="w-full p-2 border border-gray-300 rounded-md bg-white"
              value={selectedChapter}
              onChange={(e) => setSelectedChapter(e.target.value)}
              disabled={!selectedBook}
            >
              <option value="" disabled>ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
              {chapters.map((chapter) => (
                <option key={chapter} value={chapter}>{chapter}ì¥</option>
              ))}
            </select>
          </div>
          
          <button
            className={`w-full p-3 rounded-md font-medium transition-colors ${
              isFormValid 
                ? 'bg-blue-600 text-white hover:bg-blue-700' 
                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
            }`}
            onClick={generateDevotional}
            disabled={!isFormValid}
          >
            ë¬µìƒ ìƒì„±í•˜ê¸°
          </button>
        </div>
        
        {/* ë¬µìƒ ì˜ì—­ */}
        <div className="w-full md:w-1/2">
          <h2 className="text-xl font-medium text-blue-700 pb-2 border-b border-gray-200 mb-4">ì˜¤ëŠ˜ì˜ ë§Œë‚˜</h2>
          
          <div className="relative">
            <div
              className="whitespace-pre-wrap p-4 bg-gray-50 rounded-md border-l-4 border-blue-600"
              dangerouslySetInnerHTML={{ __html: devotionalText }}
            />
            
            {rawDevotionalText && (
              <button
                className={`w-full mt-3 p-2 rounded-md font-medium transition-colors ${
                  copySuccess 
                    ? 'bg-gray-500 text-white' 
                    : 'bg-green-600 text-white hover:bg-green-700'
                }`}
                onClick={copyToClipboard}
              >
                {copySuccess ? 'âœ“ ë³µì‚¬ë¨' : 'ğŸ“‹ ë³µì‚¬í•˜ê¸°'}
              </button>
            )}
          </div>
        </div>
      </div>
      
      <footer className="text-center mt-8 text-gray-500 text-sm">
        <p>ì´ ì•±ì€ GitHubì—ì„œ í˜¸ìŠ¤íŒ…ë˜ëŠ” ì„±ê²½ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
      </footer>
      
      {/* ë³µì‚¬ ì„±ê³µ ë©”ì‹œì§€ */}
      <div className={`fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-2 rounded-md shadow-md transition-opacity duration-300 ${
        showCopyMessage ? 'opacity-100' : 'opacity-0'
      }`}>
        í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
      </div>
    </div>
  );
};

export default TodaysManna;
