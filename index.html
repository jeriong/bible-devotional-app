<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘의 만나 - 성경 묵상 앱</title>
    <!-- 파비콘 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🍚</text></svg>">
    <!-- 메타 태그 -->
    <meta name="description" content="오늘의 만나 - 2025년 성경 묵상 앱">
    <meta name="keywords" content="성경, 묵상, 말씀, 오늘의 만나">
    <style>
        /* 폰트 설정 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        
        /* 전체 스타일 */
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        /* 헤더 스타일 */
        h1 {
            text-align: center;
            color: #4682B4;
            margin-bottom: 20px;
            font-weight: 700;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: 500;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading {
            background-color: #cce5ff;
            color: #004085;
        }
        
        /* 레이아웃 */
        .columns {
            display: flex;
            gap: 20px;
        }
        .column {
            flex: 1;
        }
        
        /* 폼 요소 */
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        select, button, input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 16px;
            font-family: 'Noto Sans KR', Arial, sans-serif;
        }
        select, input[type="date"] {
            background-color: white;
        }
        button {
            background-color: #4682B4;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #366b96;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* 복사 버튼 */
        .copy-button {
            background-color: #28a745;
            margin-top: 10px;
            display: none; /* 초기에는 숨김 */
        }
        .copy-button:hover {
            background-color: #218838;
        }
        .copy-button.copied {
            background-color: #6c757d;
        }
        
        /* 섹션 제목 */
        h2 {
            margin-top: 0;
            color: #4682B4;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 500;
        }
        
        /* 묵상 영역 */
        .devotional-container {
            position: relative;
        }
        .devotional {
            white-space: pre-wrap;
            line-height: 1.6;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #4682B4;
        }
        strong {
            color: #366b96;
        }
        
        /* 복사 성공 메시지 */
        .copy-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        .copy-message.show {
            opacity: 1;
        }
        
        /* 반응형 레이아웃 */
        @media (max-width: 768px) {
            .columns {
                flex-direction: column;
            }
            .container {
                padding: 15px;
            }
        }
        
        /* 로딩 스피너 */
        .spinner {
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #4682B4;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 푸터 */
        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🍚 오늘의 만나 - 성경 묵상 앱</h1>
        
        <div id="status" class="status loading">성경 데이터를 불러오는 중...<div class="spinner"></div></div>
        
        <div class="columns">
            <div class="column">
                <h2>설정</h2>
                
                <div class="form-group">
                    <label for="date">1. 날짜 선택 (선택사항):</label>
                    <input type="date" id="date" class="date-picker">
                </div>
                
                <div class="form-group">
                    <label for="book">2. 성경책 선택:</label>
                    <select id="book">
                        <option value="" disabled selected>성경책을 선택하세요</option>
                        <!-- 성경책 옵션은 JavaScript로 채워집니다 -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="chapter">3. 장 선택:</label>
                    <select id="chapter">
                        <option value="" disabled selected>장을 선택하세요</option>
                        <!-- 장 옵션은 JavaScript로 채워집니다 -->
                    </select>
                </div>
                
                <button id="generateButton">묵상 생성하기</button>
            </div>
            
            <div class="column">
                <h2>오늘의 만나</h2>
                <div class="devotional-container">
                    <div id="devotional" class="devotional">
                        성경책과 장을 선택한 후 "묵상 생성하기" 버튼을 클릭하세요.
                    </div>
                    <button id="copyButton" class="copy-button">📋 복사하기</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>이 앱은 GitHub에서 호스팅되는 성경 데이터를 사용합니다.</p>
        </footer>
    </div>
    
    <!-- 복사 성공 메시지 -->
    <div id="copyMessage" class="copy-message">클립보드에 복사되었습니다!</div>

    <script>
        // 전역 변수
        let bibleData = null;
        let rawDevotionalText = ""; // 원본 텍스트 저장용 변수 추가
        const statusElement = document.getElementById('status');
        const dateInput = document.getElementById('date'); // date input으로 변경
        const bookSelect = document.getElementById('book');
        const chapterSelect = document.getElementById('chapter');
        const generateButton = document.getElementById('generateButton');
        const devotionalElement = document.getElementById('devotional');
        const copyButton = document.getElementById('copyButton');
        const copyMessage = document.getElementById('copyMessage');
        
        // 오늘 날짜를 기본값으로 설정
        function setTodayAsDefault() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
        }
        
        // 페이지 로드시 오늘 날짜 설정
        setTodayAsDefault();
        
        // GitHub에서 성경 데이터 로드
        async function loadBibleData() {
            try {
                statusElement.className = 'status loading';
                statusElement.innerHTML = '성경 데이터를 불러오는 중...<div class="spinner"></div>';
                
                // GitHub에서 데이터 요청
                const response = await fetch('https://raw.githubusercontent.com/jeriong/bible-data/refs/heads/main/%EC%84%B1%EA%B2%BD.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP 오류: ${response.status}`);
                }
                
                bibleData = await response.json();
                
                // 데이터 로드 성공 메시지
                statusElement.className = 'status success';
                statusElement.textContent = '성경 데이터를 성공적으로 불러왔습니다!';
                
                // UI 초기화
                initializeUI();
                
            } catch (error) {
                console.error('데이터 로드 중 오류 발생:', error);
                statusElement.className = 'status error';
                statusElement.textContent = `성경 데이터를 불러올 수 없습니다: ${error.message}`;
                
                // 오류 발생 시 백업 데이터 사용
                useSampleData();
            }
        }
        
        // 백업 데이터 사용 (오류 시 최소한의 기능 제공)
        function useSampleData() {
            bibleData = {
                "창세기": {
                    "1": {
                        "1": "태초에 하나님이 천지를 창조하시니라",
                        "2": "땅이 혼돈하고 공허하며 흑암이 깊음 위에 있고 하나님의 영은 수면 위에 운행하시니라",
                        "3": "하나님이 가라사대 빛이 있으라 하시매 빛이 있었고",
                        "4": "빛이 하나님이 보시기에 좋았더라 하나님이 빛과 어둠을 나누사"
                    }
                },
                "요한복음": {
                    "3": {
                        "16": "하나님이 세상을 이처럼 사랑하사 독생자를 주셨으니 이는 저를 믿는 자마다 멸망치 않고 영생을 얻게 하려 하심이니라"
                    }
                },
                "시편": {
                    "23": {
                        "1": "여호와는 나의 목자시니 내게 부족함이 없으리로다",
                        "2": "그가 나를 푸른 초장에 누이시며 쉴 만한 물가로 인도하시는도다"
                    }
                }
            };
            
            statusElement.innerHTML += "<br><small>(일부 성경 구절만 제공됩니다. 데이터 오류가 지속되면 관리자에게 문의하세요.)</small>";
            
            // UI 초기화
            initializeUI();
        }
        
        // UI 초기화
        function initializeUI() {
            // 성경책 옵션 생성
            generateBookOptions();
            
            // 이벤트 리스너 연결
            bookSelect.addEventListener('change', updateChapterOptions);
            chapterSelect.addEventListener('change', checkFormValidity);
            generateButton.addEventListener('click', generateDevotional);
            copyButton.addEventListener('click', copyDevotionalText);
            
            // 초기 폼 상태 확인
            checkFormValidity();
        }
        
        // 성경책 옵션 생성
        function generateBookOptions() {
            bookSelect.innerHTML = '<option value="" disabled selected>성경책을 선택하세요</option>';
            
            // 성경 66권 표준 목록
            const standardBooks = [
                '창세기', '출애굽기', '레위기', '민수기', '신명기', '여호수아', '사사기', '룻기',
                '사무엘상', '사무엘하', '열왕기상', '열왕기하', '역대상', '역대하', '에스라', '느헤미야',
                '에스더', '욥기', '시편', '잠언', '전도서', '아가', '이사야', '예레미야', '예레미야애가',
                '에스겔', '다니엘', '호세아', '요엘', '아모스', '오바댜', '요나', '미가', '나훔', '하박국',
                '스바냐', '학개', '스가랴', '말라기', '마태복음', '마가복음', '누가복음', '요한복음',
                '사도행전', '로마서', '고린도전서', '고린도후서', '갈라디아서', '에베소서', '빌립보서',
                '골로새서', '데살로니가전서', '데살로니가후서', '디모데전서', '디모데후서', '디도서',
                '빌레몬서', '히브리서', '야고보서', '베드로전서', '베드로후서', '요한1서', '요한2서',
                '요한3서', '유다서', '요한계시록'
            ];
            
            // 데이터에 있는 성경책만 필터링
            const validBooks = standardBooks.filter(book => book in bibleData);
            
            for (const book of validBooks) {
                const option = document.createElement('option');
                option.value = book;
                option.textContent = book;
                bookSelect.appendChild(option);
            }
        }
        
        // 장 옵션 업데이트
        function updateChapterOptions() {
            chapterSelect.innerHTML = '<option value="" disabled selected>장을 선택하세요</option>';
            
            const selectedBook = bookSelect.value;
            if (!selectedBook || !bibleData[selectedBook]) {
                return;
            }
            
            // 장 번호를 정수로 변환하여 정렬
            const chapters = Object.keys(bibleData[selectedBook])
                .map(chapter => parseInt(chapter))
                .sort((a, b) => a - b);
            
            for (const chapter of chapters) {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = `${chapter}장`;
                chapterSelect.appendChild(option);
            }
            
            // 폼 상태 확인
            checkFormValidity();
        }
        
        // 폼 상태 확인 - 날짜 선택 없이도 생성 가능하도록 수정
        function checkFormValidity() {
            // 성경책과 장만 필수로 설정
            const isValid = bookSelect.value && chapterSelect.value;
            generateButton.disabled = !isValid;
        }
        
        // 날짜 문자열 포맷 변환 (YYYY-MM-DD -> M/D(요일))
        function formatDateString(dateStr) {
            if (!dateStr) return null;
            
            const date = new Date(dateStr);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
            const weekday = weekdays[date.getDay()];
            
            return {
                formattedDate: `${month}/${day}(${weekday})`,
                weekdayIndex: date.getDay()
            };
        }
        
        // 묵상 생성
        function generateDevotional() {
            try {
                // 입력값 확인
                const selectedBook = bookSelect.value;
                const selectedChapter = chapterSelect.value;
                
                if (!selectedBook || !selectedChapter) {
                    alert('성경책과 장을 선택해주세요.');
                    return;
                }
                
                // 날짜 정보 (선택적)
                let dateInfo = null;
                if (dateInput.value) {
                    dateInfo = formatDateString(dateInput.value);
                }
                
                // 일요일이고 날짜가 선택된 경우
                if (dateInfo && dateInfo.weekdayIndex === 0) {
                    rawDevotionalText = `🍚오늘의 만나🍚 - ${dateInfo.formattedDate}\n\n오늘은 일요일입니다.\n교회에서 예배드리고 말씀을 듣는 복된 날이 되시기 바랍니다.`;
                    
                    devotionalElement.textContent = rawDevotionalText;
                    // 복사 버튼 표시
                    copyButton.style.display = 'block';
                    return;
                }
                
                // 성경 구절 가져오기
                const chapterData = bibleData[selectedBook][selectedChapter];
                
                if (!chapterData) {
                    rawDevotionalText = `${selectedBook} ${selectedChapter}장의 데이터를 찾을 수 없습니다.`;
                    devotionalElement.textContent = rawDevotionalText;
                    // 이 경우에는 복사 버튼 숨김
                    copyButton.style.display = 'none';
                    return;
                }
                
                // 절 번호를 정수로 변환하여 정렬
                const verses = [];
                const sortedVerseNumbers = Object.keys(chapterData)
                    .map(verse => parseInt(verse))
                    .sort((a, b) => a - b);
                
                for (const verseNum of sortedVerseNumbers) {
                    verses.push(`${verseNum}. ${chapterData[verseNum.toString()]}`);
                }
                
                // 묵상 내용 생성 (원본 텍스트 저장)
                rawDevotionalText = '';
                
                // 날짜가 있는 경우에만 날짜 정보 추가
                if (dateInfo) {
                    rawDevotionalText += `🍚오늘의 만나🍚 - ${dateInfo.formattedDate}\n\n`;
                } else {
                    rawDevotionalText += `🍚오늘의 만나🍚\n\n`;
                }
                
                rawDevotionalText += `${selectedBook} ${selectedChapter}장 입니다\n`;
                rawDevotionalText += "------------------------------------------------\n\n";
                
                rawDevotionalText += `**${selectedBook} ${selectedChapter}장**\n\n`;
                rawDevotionalText += verses.join('\n\n') + '\n\n';
                
                rawDevotionalText += "------------------------------------------------\n\n";
                rawDevotionalText += "💌묵상방법(참고)💌\n";
                rawDevotionalText += "1. 시작기도🙏 후 말씀 읽기(천천히 깊게)\n\n\n";
                rawDevotionalText += "2. 묵상하기\n";
                rawDevotionalText += "👉나에게 묵상되는 말씀범위(구절)의 \"핵심제목<Keyword >\" 적어보기\n";
                rawDevotionalText += "👉\"핵심제목<Keyword >\" 에 맞는 묵상, 주님과의 약속/구체적 실천계획 세워보기\n\n\n";
                rawDevotionalText += "3. 마무리기도🙏 후 댓글로 묵상 나누기 (말씀구절/묵상/실천 등을 댓글로 달아 공유해주시면 좋습니다!)\n";
                rawDevotionalText += "------------------------------------------------";
                
                // 텍스트에서 **로 감싸진 부분을 <strong> 태그로 변환 (화면 표시용)
                const formattedDevotional = rawDevotionalText
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                devotionalElement.innerHTML = formattedDevotional;
                
                // 복사 버튼 표시
                copyButton.style.display = 'block';
                copyButton.textContent = '📋 복사하기';
                copyButton.classList.remove('copied');
                
            } catch (error) {
                console.error('묵상 생성 중 오류 발생:', error);
                devotionalElement.textContent = `오류 발생: ${error.message}`;
                // 오류 시 복사 버튼 숨김
                copyButton.style.display = 'none';
            }
        }
        
        // 묵상 내용 복사 기능
        function copyDevotionalText() {
            if (!rawDevotionalText) return;
            
            // 클립보드에 복사
            navigator.clipboard.writeText(rawDevotionalText)
                .then(() => {
                    // 성공 시 버튼 텍스트 변경
                    copyButton.textContent = '✓ 복사됨';
                    copyButton.classList.add('copied');
                    
                    // 성공 메시지 표시
                    copyMessage.classList.add('show');
                    setTimeout(() => {
                        copyMessage.classList.remove('show');
                    }, 2000);
                    
                    // 3초 후 버튼 텍스트 원복
                    setTimeout(() => {
                        copyButton.textContent = '📋 복사하기';
                        copyButton.classList.remove('copied');
                    }, 3000);
                })
                .catch(err => {
                    console.error('클립보드 복사 실패:', err);
                    copyButton.textContent = '❌ 복사 실패';
                    
                    // 3초 후 버튼 텍스트 원복
                    setTimeout(() => {
                        copyButton.textContent = '📋 복사하기';
                    }, 3000);
                });
        }
        
        // 앱 시작
        loadBibleData();
    </script>
</body>
</html>
